# EC2 Webサーバーを構築

## EC2とは
- Elastic Compute Cloudの略。AWSクラウド上の仮想サーバー
- インスタンスというのはEC2から立てられたサーバーのこと
- 数分で起動。1時間または秒単位の従量課金
- サーバーの追加、削除、マシンスペック変更も数分で可能
- OSより上のレイヤについては自由に設定できる

## EC2の作成手順
- AMIの選択
- インスタンスタイプの選択
- ストレージの追加
- セキュリティグループの設定
- SSHキーペアの設定

## AMIとは
- Amazon Machine Imageの略。インスタンス起動に必要な情報が入ったOSのイメージ
- サーバーのテンプレートのようなもの
- AWSやサードパーティがAMMIを提供
- 自前のカスタムAMIも作成可能
- カスタムAMIから何台でもEC2インスタンスを起動可能

## インスタンスタイプとは
- サーバーのスペックを定義したもの
- インスタンスタイプにより、CPU、メモリ、ストレージ、ネットワーク帯域が異なる
- インスタンスタイプにより料金が異なる。スペックが高いほど料金も高い
- アクセス数などに応じて必要なスペックのあるインスタンスタイプを選択する
- インスタンスタイプ例 m5.xlarge。インスタンスファミリー(m)、インスタンス世代(5)、インスタンスサイズ(xllarge)

## ストレージとは
- サーバーにくっつけるデータの保存場所
- EC2のストレージには`EBS`と`インスタンスストア`の2種類ある

## EBSとは
- 高い可用性と耐久性を持つストレージ
- 他のインスタンスに付け替え可能
- EC2インスタンスをStop/TerminateしてもEBSは保持可能
- Snapshotを取得しS3に保存可能
- EBSの費用が別途発生
- OSやDBなどの永続性と耐久性が必要なデータを置く
- 通常の利用ケースはEBSを選択

## インスタンスストアとは
- インスタンス専用の一時的なストレージ
- 他のインスタンスに付け替えることができない
- EC2インスタンスをStop/Terminateするとクリアされる
- 追加費用なし(無料)
- なくなってはいけないデータは置かない
- 一時ファイル、キャッシュなど、失われても問題がないデータを置く

## EC2インスタンスを設置
- サービス/EC2/インスタンス
- インスタンスの作成

## AMIの選択
- クイックスタート`Amazon Linux 2 AMI`を選択
- AWSによってメンテナンスされてるLinux
- AWSの各サービスを連携するためのツールやライブラリが入ってる
- 特に要件がなければ選択

## インスタンスタイプの選択
- インスタンスタイプは無料利用枠の`t2.micro`を選択(動作確認で十分なので)
- インスタンスの詳細の設定
  - ネットワークは作成したVPCを選択
  - サブネットはパブリックサブネットを選択(パブリックサブネットにEC2を設置するため)
  - 自動割り当てパブリックIPはインターネット経由でアクセスするグローバルIPアドレスにしたいので`有効`を選択
  - キャパシティの予約はアベイラビリティゾーンごとに利用するリソースが決まっている。それを超えるとEC2インスタンスの起動ができない。キャパシティ予約すると事前にリソースを確保してくれる。EC2インスタンスの利用有無に関係なく料金が発生する。`なし`を選択
  - 終了保護の有効化は本番環境の場合にチェックを入れる
  - T2/T3無制限はバーストモードを無制限にする。バーストモード中は料金が発生
  - ネットワークインターフェイスのパブリックサブネットのプライマリIPを`10.0.10.10`に設定

## ストレージの追加
- ボリュームタイプが`ルート`はOSが入っているストレージ
- デバイスはOSから見えるデバイス名。ルートのときは変更できない
- スナップショットはストレージの中身となるもの
- ボリュームタイプの汎用SSDは規格とパフォーマンスのバランスが取れているので多くの場合こちらを選択。プロビジョンドIOPSはDBなど高いIOが必要なとき選択
- `合わせて削除`はインスタンスを削除するとEBSも削除するか。無駄な課金を避けるためにチェック

## 新しいキーペアの作成
- タグの追加、セキュリティグループの設定が終わるとキーペアを作成する
- サーバーにSSHログインするために必要
