# udemy-WordPress-by-AWS

## AWSとインフラの基礎知識

### インフラができるメリット
- 自分でサービスを作れる
-　障害があったときにどこに問題があるかわかるようになる
- 対応策がアプリケーションだけではなくシステム全体で対応できるようになる

### インフラ構築時の手順
- どのようなサーバーが必要か
- サーバーのOSをインストールし、各種設定を行う
- 必要なソフトウェアをインストール
- 構築したサーバーをネットワークに接続する
- IPアドレスの範囲を決める
- サーバーにIPアドレスを割り当てる
- ドメイン名とIPアドレスの対応を割り当てる

### AWSの特徴
- サービスが豊富
- フルマネージドサービスを使うことで高負荷に耐えられる信頼性の高いシステムを少ない手間で運用できる
- リソースが柔軟。必要なときに必要な分だけ調達できる
- 従量課金モデル。使った分だけ支払う

### インフラとは
- サーバーやネットワークのこと

### サーバーとは
- クライアントに対してサービスを提供するコンピューター

### ネットワークとは
- 複数のコンピューターをつないで、データを送受信できるようにするもの
- クライアントとサーバー間でデータの送受信

### クラウドとは
- ネットワークを利用してコンピューターリソースを利用する形態のこと
- ネットワーク経由で使用/管理できる
- 初期コストが少なく、すぐに始めることができる
- サーバーの増減が自由にできる
- 費用の予測が付きづらい
-　クラウド全体で障害が起こると対応できない

### オンプレミスとは
- インフラを自前で用意して、自社で所有/管理するここと
- 初期コストがかかり調達期間が必要
- サーバーの増減がしにくい

## AWS初期設定

### 料金アラートを設定
- AWSの利用料金がいくらを超えたら通知するように設定
- 請求ダッシュボードで請求アラートを受け取るように設定
- CloudWatchで料金アラートを設定

### 請求ダッシュボードで請求アラートを受け取るように設定
- アカウント名/マイ請求ダッシュボード/Billingの設定
- `電子メールで PDF 版請求書を受け取る`にチェック
- `無料利用枠の使用のアラートの受信`にチェック(1年間の無料枠を超えそうになったらアラート)。Eメールアドレスに入力
- `請求アラートを受け取る`にチェック→CloudWatchで料金アラートを設定することができる

### CloudWatchで料金アラートを設定
- `請求アラートを管理する`をクリック
- CloudWatch/請求/アラームの作成
- 請求アラームで超過の額を設定(10USD)
- 通知の連絡先入力

### IAMで作業用ユーザーを作成
- AWSアカウントを作成するとルートユーザーが作成される
- ルートユーザーは普段は使用せず、作業用のIAMユーザーを使用するのがベストプラクティス

### ルートユーザーとは
- 全てのAWSサービスとAWSリソース全てにアクセス権を持つユーザー
- アカウントの変更、解約、サポートプランの変更等のみ使用
- 極力ルートユーザーは使用しない

### IAMユーザー
- AWSで作成するユーザー
- 認証情報とアクセス許可の権限を個別に変更できる
- 作業者ごとに個別に作成
- 通常の作業はIAMユーザーで行う
- エンジニア、ディレクターによって権限を分ける

### ルートユーザーでの作業
- マイアカウント/IAM ユーザー/ロールによる請求情報へのアクセス/編集
- IAM アクセスのアクティブ化(IAMユーザーで請求情報が閲覧できる)

### IAMユーザーの設定
- サービス/IAMで検索
- ユーザー/ユーザーを追加
- アクセスの種類`AWS マネジメントコンソールへのアクセス`にチェック
- `パスワードのリセットが必要`他の作業者のためのユーザー作成時にチェック。`自動生成パスワード`を選択
- `既存のポリシーを直接アタッチ`AWSが定めたデフォルトの権限
- `AdministratorAccess`にチェック。ほとんどのサービスにアクセスできる権限
- `タグの追加`そのユーザーがどういう役割かを入力

### 操作ログを記録しよう
- いつ誰が何をしたのかを記録しておく
- 不正アクセスや不正操作があったときにチェックできるようにする
- CloudTrailで証跡を作成
- S3にログが保存される

### CloudTrailとは
- AWSユーザーの操作を記録するサービス
- 操作ログをS3に保存(永久に保存できる)
- CloudTrail自体は無料。S3の料金はかかる

### CloudTrail設定
- サービス/CloudTrailで検索
- 証跡の作成
- データイベント/S3/`アカウントのすべての S3 バケットの選択`にチェック
- ストレージの場所/新しい S3 バケットを作成しますかで`はい`を選択
- S3バケット名を入力

## VPCネットワークを構築

### リージョンとは
- AWSの各サービスが提供されている地域のこと
- リージョンによって使えるサービスが異なる
-　最新機能はアメリカのリージョンで使える
- 日本の場合は東京リージョンを選択

### アベイラビリティゾーンとは
- AWSは各国にデータセンターをもっている
- 複数のデータセンターを束ねたものがアベイラビリティゾーン
- リージョンには２つ以上のアベイラビリティゾーンが物理的に離れて存在する
- 複数ある理由は災害があってアベイラビリティゾーンが使えなくても他のアベイラビリティゾーンが使えるため
- 東京には3つのアベイラビリティゾーンがある「ap-northeast-1a」「ap-northeast-1c」「ap-northeast-1d」

### VPCとは
- virtual private cloudの頭文字
- AWS上に仮想ネットワークを作成できるサービス
- VPCを作成するときはリージョンを選択。リージョンをまたぐことは出来ない
- VPCのなかで区切りられたネットワーク(サブネット)をつくる

### サブネットとは
- VPCを細かく区切ったネットワーク
- サブネットの種類にパブリックサブネット、プライベートサブネットがある
- サブネットはアベイラビリティゾーンのなかで作る
- 複数のアベイラビリティゾーンにサブネットが作れる
- 1つのアベイラビリティゾーンが利用できなくても他のアベイラビリティゾーンで稼働ができる

### IPアドレスとは
- ネットワーク上の機器を識別するためのインターネット上の住所
- ネットワーク上で重複しない番号
- 32ビットの整数値で構成される
- 32ビットのIPアドレスを8ビットずつの4つの組に分け、ピリオドを入れて10進数で表現
- 0.0.0.0〜255.255.255.255まで

### パブリックIPアドレスとは
- インターネットに接続する際に使用するIPアドレス
- 重複すると正しく通信できなくなる
- ICANがIPアドレスを管理
- プロバイダーやサーバー事業者から貸し出される(AWS上でも貸し出される)

### プライベートIPアドレスとは
- インターネットで使用されないIPアドレス
- 世界でユニークなアドレスでなくても良い
- 使用範囲内なら自由に使える
 - 10.0.0.0〜10.255.255.255
 - 172.16.0.0〜172.31.255.255
 - 192.168.0.0〜192.168.255.255
- 社内LANの構築やネットワークの実験時はプライベートIPアドレスを使用

### IPアドレスの範囲を表記
- ネットワークを構築する際はそのネットワークで使うIPアドレスの範囲を決める
- IPアドレスはネットワーク部とホスト部に区分けることで範囲を表記
- 192.168.128.0〜192.168.128.255の256個のIPアドレスの場合
 - 192.168.128がネットワーク部
 - 可変部分の0〜255のホスト部

### 範囲の表記法 CIDR表記
- IPアドレスの後ろに「/」を書き、その後ろにネットワーク部が先頭から何ビット目までなのかを記載
- 192.168.128.0〜192.168.128.255の256個のIPアドレスの場合
- ネットワーク部が24ビット
 - 192.168.128.0/24
 - 24ビットより後ろはホスト部

### 範囲の表記法 サブネットマスク表記
- IPアドレスの後ろに「/」を書き、ネットワーク部を表すビットと同じ部分を1に、ホスト部を表すビットと同じ部分を0にする
- 192.168.128.0〜192.168.128.255の256個のIPアドレスの場合
  - 192.168.128.0/255.255.255.0

### VPCを作成
- リージョンを東京に変更
- VPC/VPCの作成をクリック
- IPv4 CIDR ブロックを`10.0.0.0/16`で入力
- デフォルトでVPCが存在するが作成のVPCを選択

### サブネットを作成
- 作成したVPCをサブネットで分割する
- パブリックサブネットとプライベートサブネットを作成
- パブリックサブネットはWEBサーバーを設置してインターネットから接続
- プライベートサブネットはDBサーバーを設置してインターネットから隠す

### パブリックサブネットの作成
- VPC/サブネット/サブネットの作成
- VPCの選択に作成したVPCを選択
- アベイラビリティゾーンで`ap-northeast-1a`を選択
- IPv4 CIDR ブロックで`10.0.10.0/24`と入力

### プライベートサブネットの作成
- VPC/サブネット/サブネットの作成
- VPCの選択に作成したVPCを選択
- アベイラビリティゾーンで`ap-northeast-1a`を選択
- IPv4 CIDR ブロックで`10.0.20.0/24`と入力

### ルーティングを設定
- パブリックサブネットからインターネットに接続
- パブリックサブネットに設置するWEBサーバーにWordPressをインストール

### IPアドレスとルーティング
- インターネットではルーターがIPアドレスの行き先を管理
- ネットワークとネットワークがIPアドレスを通じて接続(ルーティング)
- ルートテーブルはどのIPアドレスかどこにあるかを管理
  - ルートテーブルは「宛先のIPアドレス」と「次のルーター(AWSはターゲット)」という書式で設定
  - 接続しているルート(local)
  - 他に接続しているルート
  - 0.0.0.0/0のデフォルトルート。どのアドレスにも一致しない場合の経路
- パブリックサブネット用のルートテーブルを作成。0.0.0.0/0をインターネットゲートウェイに向ける

### インターネットゲートウェイをVPCにアタッチ
- VPC/インターネットゲートウェイ
- インターネットゲートウェイの作成
- 作成したゲートウェイを選択
- アクション/VPCにアタッチ
- 作成したVPCを選択してアタッチ

### パブリックサブネット用のルートテーブルを作成
- VPC/ルートテーブル
- ルートテーブルの作成
- 作成したVPCを選択
- 作成したルートテーブルを選択/サブネットの関連付けをクリック
- サブネットの関連付けを編集/パブリックサブネットを選択

### デフォルトルートをインターネットゲートウェイに設定
- パブリックサブネットのルートテーブルを選択
- ルート/ルートの編集
- ルートの追加
 - 送信先を0.0.0.0/0
 - ターゲットを作成したインターネットゲートウェイを選択

### VPC設計ポイント
- プライベートIPアドレス範囲から指定
- IPアドレスの範囲は作成後は変更できないので大きめに設定。/16が推奨
- オンプレミスや他VPCのレンジと重複しないようにする
- 異なるシステムの場合はアカウントを分ける
- PROとSTG環境の違いは同一アカウントでVPCとリージョンを分ける

### サブネット設計のポイント
- 将来に必要なIPアドレス数を見積もる。/24が標準的
- サブネットの分割はルーティングとアベイラビリティゾーンを基準に行う
- インターネットアクセスの有無。拠点アクセスの有無などのルーティングポリシーに応じて分割
- 高可用性のために2つ以上のアベイラビリティゾーンを使用

## 【EC2】Webサーバーを構築

### EC2とは
- Elastic Compute Cloudの略。AWSクラウド上の仮想サーバー
- インスタンスというのはEC2から立てられたサーバーのこと
- 数分で起動。1時間または秒単位の従量課金
- サーバーの追加、削除、マシンスペック変更も数分で可能
- OSより上のレイヤについては自由に設定できる

### EC2の作成手順
- AMIの選択
- インスタンスタイプの選択
- ストレージの追加
- セキュリティグループの設定
- SSHキーペアの設定

### AMIとは
- Amazon Machine Imageの略。インスタンス起動に必要な情報が入ったOSのイメージ
- サーバーのテンプレートのようなもの
- AWSやサードパーティがAMMIを提供
- 自前のカスタムAMIも作成可能
- カスタムAMIから何台でもEC2インスタンスを起動可能

### インスタンスタイプとは
- サーバーのスペックを定義したもの
- インスタンスタイプにより、CPU、メモリ、ストレージ、ネットワーク帯域が異なる
- インスタンスタイプにより料金が異なる。スペックが高いほど料金も高い
- アクセス数などに応じて必要なスペックのあるインスタンスタイプを選択する
- インスタンスタイプ例 m5.xlarge。インスタンスファミリー(m)、インスタンス世代(5)、インスタンスサイズ(xllarge)

### ストレージとは
- サーバーにくっつけるデータの保存場所
- EC2のストレージには`EBS`と`インスタンスストア`の2種類ある

### EBSとは
- 高い可用性と耐久性を持つストレージ
- 他のインスタンスに付け替え可能
- EC2インスタンスをStop/TerminateしてもEBSは保持可能
- Snapshotを取得しS3に保存可能
- EBSの費用が別途発生
- OSやDBなどの永続性と耐久性が必要なデータを置く
- 通常の利用ケースはEBSを選択

### インスタンスストアとは
- インスタンス専用の一時的なストレージ
- 他のインスタンスに付け替えることができない
- EC2インスタンスをStop/Terminateするとクリアされる
- 追加費用なし(無料)
- なくなってはいけないデータは置かない
- 一時ファイル、キャッシュなど、失われても問題がないデータを置く

### EC2インスタンスを設置
- サービス/EC2/インスタンス
- インスタンスの作成

### AMIの選択
- クイックスタート`Amazon Linux 2 AMI`を選択
- AWSによってメンテナンスされてるLinux
- AWSの各サービスを連携するためのツールやライブラリが入ってる
- 特に要件がなければ選択

### インスタンスタイプの選択
- インスタンスタイプは無料利用枠の`t2.micro`を選択(動作確認で十分なので)
- インスタンスの詳細の設定
  - ネットワークは作成したVPCを選択
  - サブネットはパブリックサブネットを選択(パブリックサブネットにEC2を設置するため)
  - 自動割り当てパブリックIPはインターネット経由でアクセスするグローバルIPアドレスにしたいので`有効`を選択
  - キャパシティの予約はアベイラビリティゾーンごとに利用するリソースが決まっている。それを超えるとEC2インスタンスの起動ができない。キャパシティ予約すると事前にリソースを確保してくれる。EC2インスタンスの利用有無に関係なく料金が発生する。`なし`を選択
  - 終了保護の有効化は本番環境の場合にチェックを入れる
  - T2/T3無制限はバーストモードを無制限にする。バーストモード中は料金が発生
  - ネットワークインターフェイスのパブリックサブネットのプライマリIPを`10.0.10.10`に設定

### ストレージの追加
- ボリュームタイプが`ルート`はOSが入っているストレージ
- デバイスはOSから見えるデバイス名。ルートのときは変更できない
- スナップショットはストレージの中身となるもの
- ボリュームタイプの汎用SSDは規格とパフォーマンスのバランスが取れているので多くの場合こちらを選択。プロビジョンドIOPSはDBなど高いIOが必要なとき選択
- `合わせて削除`はインスタンスを削除するとEBSも削除するか。無駄な課金を避けるためにチェック

### 新しいキーペアの作成
- タグの追加、セキュリティグループの設定が終わるとキーペアを作成する
- サーバーにSSHログインするために必要

### SSHログインについて
- 離れた場所にあるサーバーに入って自分のパソコンから操作すること

### SSHとは
- サーバーと自分のパソコンをセキュアにつなぐサービスのこと
- 通信内容が暗号化された遠隔ログインシステム
- ログインする側をSSHクライアント
- ログインされる側をSSHサーバー
- 通信内容が暗号化されているので第三者が介入できない

### 公開鍵認証について
- サーバーの作成者本人だけがログインできるようSSHログイン時に公開鍵認証を行っている
- サーバーへのログイン時に認証を行う仕組み
- ユーザー名とパスワードを使用した認証と比べセキュリティが高い
- 公開鍵暗号(秘密鍵と公開鍵)を用いて認証を行う
- 公開鍵はサーバーが保有
- 秘密鍵を持っているユーザーだけがログイン可能

### 公開鍵暗号
- 暗号とは他の人には内容を分からないようにしてメッセージのやり取りを行うのが暗号
- 南京錠をイメージ。誰でもロックができる。南京錠を解除するには鍵が必要
- メッセージを公開鍵で暗号化(暗号文)
- メッセージを秘密鍵で復号化(平文に)
